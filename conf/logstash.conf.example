input {
  udp {
    port => 1514
    type => "syslog"
  }
  tcp {
    port => 1514
    type => "syslog"
  }
}

filter {
  # Structured syslog format: topic1,topic2,level message_content
  # Example: "bridge,stp,debug ether5 tx bpdu..."
  grok {
    match => { "message" => "(?<topics_raw>\\w+(?:,\\w+)*),(?<log_level>\\w+)\\s+(?<log_message>.*)" }
    ecs_compatibility => "v1"
    tag_on_failure => ["_grokparsefailure"]
  }
  
  # Extract syslog topics and level
  if [topics_raw] {
    mutate {
      split => { "topics_raw" => "," }
      add_field => { "topics" => "%{topics_raw}" }
    }
  }
  
  # Detect structured syslog and parse topics
  if [topics_raw] {
    # Mark as structured syslog
    mutate {
      add_field => { 
        "log_type" => "structured_syslog"
        "data_source" => "network_device"
      }
    }
    
    # Extract facility (first topic)
    if [topics_raw][0] {
      mutate { add_field => { "log_facility" => "%{[topics_raw][0]}" } }
    }
    if [topics_raw][1] {
      mutate { add_field => { "log_subsystem" => "%{[topics_raw][1]}" } }
    }
    
    # Bridge/STP events
    if [log_facility] == "bridge" {
      grok {
        match => { "log_message" => "(?<interface>\\w+)\\s+(?<direction>tx|rx)\\s+(?<packet_type>\\w+)" }
        ecs_compatibility => "v1"
      }
      mutate {
        add_field => { "event_type" => "bridge_protocol" }
      }
    }
    
    # Firewall events
    if "firewall" in [topics_raw] {
      mutate {
        add_field => { "event_type" => "firewall" }
      }
    }
  }
  
  # General enrichment
  mutate {
    add_field => { 
      "ingestion_timestamp" => "%{@timestamp}"
      "data_pipeline" => "logstash_enhanced"
    }
  }
}

output {
  # Network device logs with structured indices
  if [log_type] == "structured_syslog" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "network-logs-%{+YYYY.MM.dd}"
      user => "${ELASTIC_USERNAME:elastic}"
      password => "${ELASTIC_PASSWORD}"
      manage_template => false
      template_name => "network-logs"
    }
  } else {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "syslog-%{+YYYY.MM.dd}"
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
      manage_template => false
      template_name => "syslog"
    }
  }
  
  # Debug output for structured syslog
  if [log_type] == "structured_syslog" {
    stdout {
      codec => rubydebug {
        metadata => false
      }
    }
  }
}
