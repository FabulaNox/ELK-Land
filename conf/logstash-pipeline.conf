input {
  udp {
    port => 1514
    type => "syslog"
  }
  tcp {
    port => 1514
    type => "syslog"
  }
}

filter {
  # Basic syslog parsing - ECS compliant
  grok {
    match => { "message" => "%{SYSLOGTIMESTAMP:timestamp} %{IPORHOST:router_host} %{GREEDYDATA:mikrotik_message}" }
    ecs_compatibility => "v1"
    tag_on_failure => ["_grokparsefailure"]
  }
  
  # Enhanced MikroTik RouterOS parsing for portfolio showcase
  # Detects MikroTik logs by common router IP patterns - adjust regex for your network
  if [router_host] =~ /(192\.168\.\d+\.\d+|10\.\d+\.\d+\.\d+|172\.(1[6-9]|2[0-9]|3[01])\.\d+\.\d+)/ {
    # Mark as MikroTik for portfolio categorization
    mutate {
      add_field => { 
        "log_type" => "mikrotik"
        "data_source" => "logstash_enhanced"
        "portfolio_category" => "network_security"
      }
    }
    
    # Firewall log parsing - SHOWCASE SECURITY MONITORING
    if [mikrotik_message] =~ /firewall/ {
      grok {
        match => { "mikrotik_message" => "(?<topics>[^:]+): (?<action>\w+): in:%{DATA:in_interface}(?:\s+out:%{DATA:out_interface})?,? (?:src-mac %{MAC:src_mac},? )?(?:proto %{WORD:protocol},? )?%{IP:src_ip}(?::%{INT:src_port})?->%{IP:dst_ip}(?::%{INT:dst_port})?(?:, len %{INT:packet_length})?(?:, %{GREEDYDATA:additional_info})?" }
        ecs_compatibility => "v1"
        tag_on_failure => ["_grokparsefailure", "_firewall_parse_failure"]
      }
      mutate {
        add_field => { 
          "event_type" => "firewall"
          "security_event" => "true"
          "network_direction" => "%{in_interface} -> %{out_interface}"
        }
      }
    }
    
    # DHCP log parsing - SHOWCASE NETWORK MANAGEMENT
    else if [mikrotik_message] =~ /dhcp/ {
      grok {
        match => { "mikrotik_message" => "(?<topics>[^:]+): (?<dhcp_action>assigned|deassigned|expired|released) %{IP:client_ip} to %{MAC:client_mac}(?:\s+%{GREEDYDATA:client_hostname})?" }
        ecs_compatibility => "v1"
        tag_on_failure => ["_grokparsefailure", "_dhcp_parse_failure"]
      }
      mutate {
        add_field => { 
          "event_type" => "dhcp"
          "network_event" => "true"
        }
      }
    }
    
    # Authentication events - SHOWCASE ACCESS CONTROL
    else if [mikrotik_message] =~ /(login|logout|logged)/ {
      grok {
        match => { "mikrotik_message" => "(?<topics>[^:]+): user %{WORD:username} (?<auth_action>logged in|logged out|login failed)(?: from %{IP:src_ip})?(?: via %{WORD:connection_method})?" }
        ecs_compatibility => "v1"
        tag_on_failure => ["_grokparsefailure", "_auth_parse_failure"]
      }
      mutate {
        add_field => { 
          "event_type" => "authentication"
          "security_event" => "true"
        }
      }
    }
    
    # Wireless events - SHOWCASE WIFI MONITORING  
    else if [mikrotik_message] =~ /(wireless|wifi)/ {
      grok {
        match => { "mikrotik_message" => "(?<topics>[^:]+): (?<client_mac>%{MAC}) (?<wireless_action>connected|disconnected|authenticated)(?:, signal strength (?<signal_strength>-?\d+))?" }
        ecs_compatibility => "v1"
        tag_on_failure => ["_grokparsefailure", "_wireless_parse_failure"]
      }
      mutate {
        add_field => { 
          "event_type" => "wireless"
          "network_event" => "true"
        }
      }
    }
    
    # Interface events - SHOWCASE INFRASTRUCTURE MONITORING
    else if [mikrotik_message] =~ /(interface|link)/ {
      grok {
        match => { "mikrotik_message" => "(?<topics>[^:]+): (?<interface_name>\w+) (?<interface_action>link up|link down|running|not running)" }
        ecs_compatibility => "v1"
        tag_on_failure => ["_grokparsefailure", "_interface_parse_failure"]
      }
      mutate {
        add_field => { 
          "event_type" => "interface"
          "infrastructure_event" => "true"
        }
      }
    }
  }
  
  # General enrichment for all logs
  mutate {
    add_field => { 
      "ingestion_timestamp" => "%{@timestamp}"
      "data_pipeline" => "logstash_enhanced"
    }
  }
  
  # GeoIP enrichment for external IPs (portfolio showcase) - ECS compliant
  if [src_ip] and [src_ip] !~ /^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[01]))/ {
    geoip {
      source => "src_ip"
      target => "source"
      tag_on_failure => ["_geoip_lookup_failure"]
    }
  }
  
  if [dst_ip] and [dst_ip] !~ /^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[01]))/ {
    geoip {
      source => "dst_ip" 
      target => "destination"
      tag_on_failure => ["_geoip_lookup_failure"]
    }
  }
}

output {
  # Portfolio-optimized indices for easy querying
  if [log_type] == "mikrotik" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "portfolio-mikrotik-%{+YYYY.MM.dd}"
      user => "elastic"
      password => "changeme"
      # Disable problematic license checking
      manage_template => false
      template_name => "portfolio-mikrotik"
    }
  } else {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "portfolio-syslog-%{+YYYY.MM.dd}"
      user => "elastic"
      password => "changeme"
      # Disable problematic license checking
      manage_template => false
      template_name => "portfolio-syslog"
    }
  }
  
  # Debug output (remove for production)
  if [log_type] == "mikrotik" {
    stdout {
      codec => rubydebug {
        metadata => false
      }
    }
  }
}
